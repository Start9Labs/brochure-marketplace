<div
  *ngIf="pkg$ | async as pkg; else loading"
  class="m-auto w-[95vw] md:w-[70vw] max-w-5xl h-screen relative"
  [@tuiFadeIn]="getAnimation(speed)">
  <div class="grid grid-flow-row gap-8">
    <button
      routerLink="/marketplace"
      tuiIconButton
      icon="tuiIconArrowLeftLarge"
      type="button"
      appearance="flat"
      class="m-2 md:my-8"></button>

    <ng-container *ngIf="pkg | empty; else show">
      <ng-container *ngIf="version$ | async as version">
        <h2 class="m-auto text-center">
          {{ pkgId }} version {{ version === '*' ? 'latest' : version }} not
          found in this registry
        </h2>
      </ng-container>
    </ng-container>

    <ng-template #show>
      <!-- <marketplace-package [pkg]="pkg"></marketplace-package> -->

      <div class="container mb-16">
        <div
          class="overflow-hidden absolute w-full h-full top-0 left-0 -z-50 rounded-3xl bg-black">
          <div
            class="absolute top-0 left-0 w-full h-full bg-center panel"></div>
          <img
            [src]="'data:image/png;base64,' + pkg.icon | trustUrl"
            class="absolute object-cover pointer-events-none w-[200%] h-[200%] max-w-[200%] blur-[100px] saturate-150"
            alt="{{ pkg.manifest.title }} Icon" />
        </div>
        <div class="grid grid-flow-row gap-8">
          <!-- icon -->
          <img
            [src]="'data:image/png;base64,' + pkg.icon | trustUrl"
            class="w-24 h-24 pointer-events-none absolute top-16 md:top-[6.5rem] left-7 rounded-full object-cover shadow-xl"
            alt="{{ pkg.manifest.title }} Icon"
            style="transform: none" />
          <!-- header -->
          <div
            class="flex flex-col h-[35vh] w-[150%] md:w-[70vw] relative rounded-3xl pt-16 pb-10 px-8 shadow-xl overflow-clip">
            <!-- <div
              class="overflow-hidden absolute w-full h-full top-0 left-0 -z-50 rounded-3xl bg-black">
              <div
                class="absolute top-0 left-0 w-full h-full bg-center panel"></div>
              <img
                [src]="'data:image/png;base64,' + pkg.icon | trustUrl"
                class="absolute object-cover pointer-events-none w-[200%] h-[200%] max-w-[200%] blur-[100px] saturate-150"
                alt="{{ pkg.manifest.title }} Icon" />
            </div> -->
            <div class="mt-3">
              <span
                class="block text-2xl font-medium text-zinc-50/90 line-clamp-1 mb-1"
                >{{ pkg.manifest.title }}</span
              ><span class="block text-zinc-50/70 h-11 line-clamp-2">{{
                pkg.manifest.description.short
              }}</span>
            </div>
            <div *ngIf="pkg.screenshots">
              <tui-carousel
                [draggable]="true"
                [itemsCount]="2"
                [(index)]="index"
                class="overflow-y-hidden overflow-x-scroll">
                <ng-container
                  *ngFor="let item of pkg.screenshots; let i = index">
                  <div
                    *tuiItem
                    draggable="false"
                    [class.item_active]="i === index + 1"
                    class="rounded-lg md:rounded-xl object-cover p-2 border-2 border-zinc-700 bg-zinc-800">
                    <img
                      alt="Service Screenshot"
                      src="img/{{ item }}"
                      class="drop-shadow-xl" />
                  </div>
                </ng-container>
              </tui-carousel>
            </div>
          </div>
          <!-- release notes -->
          <div
            class="h-full w-[95vw] md:w-[70vw] rounded-3xl bg-gradient-to-r from-cyan/75 to-lime/75 p-px shadow-lg">
            <div class="bg-zinc-800 rounded-3xl p-7">
              <p
                *ngIf="pkg['published-at'] as published"
                class="tui-island__category">
                Latest Release - {{ published | date : 'medium' }}
              </p>
              <h3 class="tui-island__title">
                What's new in <b>{{ pkg.manifest.version }}</b>
              </h3>
              <p
                class="tui-island__paragraph"
                [innerHTML]="pkg.manifest['release-notes']"></p>
              <button
                tuiButton
                type="button"
                appearance="secondary"
                size="m"
                class="mt-3">
                Past release notes
              </button>
            </div>
          </div>
          <!-- description-->
          <div
            class="h-full w-[95vw] md:w-[70vw] rounded-3xl bg-gradient-to-r from-veronica/75 to-cyan/75 p-px shadow-lg">
            <div class="bg-zinc-800 rounded-3xl p-7">
              <!-- <marketplace-about [pkg]="pkg"></marketplace-about> -->
              <p class="tui-island__category">About</p>
              <p class="tui-island__paragraph">
                {{ pkg.manifest.description.long }}
              </p>
              <button
                *ngIf="pkg.manifest['marketing-site'] as url"
                tuiButton
                href="url"
                target="_blank"
                rel="noreferrer"
                type="button"
                appearance="custom"
                size="m"
                class="mt-3">
                View website
              </button>
            </div>
          </div>
          <!-- dependencies -->
          <div
            *ngIf="!(pkg.manifest.dependencies | empty)"
            class="h-full w-[95vw] md:w-[70vw] rounded-3xl bg-gradient-to-r from-tangerine/75 to-royal/75 p-px shadow-lg">
            <div class="bg-zinc-800 rounded-3xl p-7">
              <p class="tui-island__category pb-7">Dependencies</p>
              <!-- <marketplace-dependencies
                *ngIf="!(pkg.manifest.dependencies | empty)"
                [pkg]="pkg"></marketplace-dependencies> -->
              <div class="h-full flex flex-col md:flex-row gap-6">
                <div *ngFor="let dep of pkg.manifest.dependencies | keyvalue">
                  <a [routerLink]="['/marketplace', dep.key]">
                    <div
                      class="h-full relative bg-zinc-700 rounded-3xl py-10 px-8 gap-2 shadow-xl">
                      <img
                        [src]="
                          'data:image/png;base64,' +
                            pkg['dependency-metadata'][dep.key].icon | trustUrl
                        "
                        class="w-16 h-15 pointer-events-none absolute -top-7 rounded-full object-cover shadow-xl"
                        alt="{{
                          pkg['dependency-metadata'][dep.key].title
                        }} Icon"
                        style="transform: none" />
                      <div class="mt-3">
                        <span
                          class="block text-2xl font-medium text-zinc-50/90 line-clamp-1 mb-1"
                          >{{ pkg['dependency-metadata'][dep.key].title }}</span
                        >
                        <p>
                          <ng-container [ngSwitch]="dep.value.requirement.type">
                            <span *ngSwitchCase="'required'">(required)</span>
                            <span *ngSwitchCase="'opt-out'"
                              >(required by default)</span
                            >
                            <span *ngSwitchCase="'opt-in'">(optional)</span>
                          </ng-container>
                        </p>
                        <span class="block text-zinc-50/70 h-11 line-clamp-2">{{
                          dep.value.description
                        }}</span>
                      </div>
                    </div>
                  </a>
                </div>
              </div>
            </div>
          </div>
          <!-- additional info-->
          <div
            class="h-full w-[95vw] md:w-[70vw] rounded-3xl bg-gradient-to-r from-lime/75 to-tangerine/75 p-px shadow-lg">
            <div class="bg-zinc-800 rounded-3xl p-7">
              <p class="tui-island__category">Information</p>
              <marketplace-additional
                class="additional"
                [pkg]="pkg"
                (version)="version$.next($event)"></marketplace-additional>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </div>
</div>

<ng-template #loading>
  <text-spinner text="Loading Package"></text-spinner>
</ng-template>
